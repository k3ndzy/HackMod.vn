<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Cen iOS - Link C√†i T·ªëc ƒê·ªô Cao</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="styles.css" />
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
</head>

<body>
  <button class="toggle-theme" onclick="toggleTheme()">üåô Chuy·ªÉn n·ªÅn</button>

  <div id="notification" class="notification hidden">
    <div class="notification-content">
      <span class="notification-icon">üîî</span>
      <span class="notification-text"></span>
      <button class="notification-close" onclick="closeNotification()">√ó</button>
    </div>
  </div>

  <div class="container">
    <header class="header">
      <h1>üéÆ Cen iOS Store</h1>
    </header>

    <!-- GAME ICONS GRID -->
    <div class="games-grid">
      <div class="game-icon-card" onclick="openGameSidebar('pubg')">
        <div class="card-badge vip">VIP</div>
        <img src="Cenios.png" alt="PUBG">
        <span class="game-name">PUBG</span>
      </div>
      <div class="game-icon-card" onclick="openGameSidebar('aov')">
        <div class="card-badge updated">M·ªöI</div>
        <img src="Aov.png" alt="Li√™n Qu√¢n VN/TW/RoV">
        <span class="game-name">Li√™n Qu√¢n VN/TW/RoV</span>
      </div>
      <div class="game-icon-card" onclick="openGameSidebar('tocchien')">
        <div class="card-badge updated">M·ªöI</div>
        <img src="Tocchien.jpeg" alt="T·ªëc Chi·∫øn All Version">
        <span class="game-name">T·ªëc Chi·∫øn All Version</span>
      </div>
      <div class="game-icon-card" onclick="openGameSidebar('cod')">
        <div class="card-badge vip">VIP</div>
        <img src="COD.jpeg" alt="Call of Duty All Version">
        <span class="game-name">Call of Duty All Version</span>
      </div>
      <div class="game-icon-card" onclick="openGameSidebar('pubgkorea')">
        <div class="card-badge vip">VIP</div>
        <img src="Cenios.png" alt="PUBG Korea">
        <span class="game-name">PUBG Korea</span>
      </div>
    </div>

    <!-- TEST ACCOUNT SECTION -->
    <div style="margin-top: 32px;">
      <h2 style="font-size: 20px; margin-bottom: 16px; color: var(--text-color); text-align: center; font-weight: 700;">
        üß™ T√†i Kho·∫£n Test
      </h2>
      <div class="games-grid" style="background: linear-gradient(135deg, #f3e5f5 0%, #ede7f6 100%);">
        <div class="game-icon-card" onclick="openGameSidebar('accrankvang')">
          <img src="35k.jpeg" alt="Acc Test Rank V√†ng">
          <span class="game-name">Acc Test Rank V√†ng</span>
        </div>
        <div class="game-icon-card" onclick="openGameSidebar('acctrangutinh')">
          <img src="10k.jpeg" alt="Acc Test Tr·∫Øng Tinh">
          <span class="game-name">Acc Test Tr·∫Øng Tinh</span>
        </div>
      </div>
    </div>

    <!-- üî• FEATURED DAILY KEY SECTION -->
    <div id="dailyKeyBanner" class="daily-key-banner" style="display: none;">
      <div class="daily-key-content">
        <div class="daily-key-header">
          <h2>üî• KEY MI·ªÑN PH√ç H√îM NAY</h2>
          <span class="daily-key-tag">Limited Time</span>
        </div>
        
        <div class="daily-key-info">
          <div class="daily-key-app">
            <span class="app-badge" id="dailyKeyAppBadge">PUBG</span>
          </div>
          
          <div class="daily-key-details">
            <div class="daily-key-code">
              <span class="key-label">üîë M√£:</span>
              <code class="key-value" id="dailyKeyCodeDisplay">Loading...</code>
              <button class="btn-copy-daily" onclick="copyDailyKeyFromWebsite()">üìã Copy</button>
            </div>
            
            <div class="daily-key-timer">
              <span class="timer-label">‚è±Ô∏è C√≤n:</span>
              <span class="timer-value" id="dailyKeyCountdown">Loading...</span>
            </div>
            
            <div class="daily-key-meta">
              <span class="meta-item">üìä <span id="dailyKeyUsed">0</span>/<span id="dailyKeyMax">50</span> used</span>
              <span class="meta-item">‚è≥ <span id="dailyKeyDuration">6</span>h duration</span>
            </div>
          </div>
        </div>
        
        <div class="daily-key-action">
          <button class="btn btn-large" onclick="activateDailyKey()">üöÄ K√çCH HO·∫†T KEY</button>
        </div>
      </div>
    </div>

    <!-- GAME SIDEBAR (Hidden by default) -->
    <div class="game-sidebar" id="gameSidebar">
      <div class="sidebar-overlay" onclick="closeGameSidebar()"></div>
      <div class="sidebar-content" id="sidebarContent">
        <!-- Content will be loaded dynamically -->
      </div>
    </div>

    <div class="card" data-app="pubg" style="display: none;">
      <img class="card-banner" src="banner.jpg" alt="FunTap PUBG Banner">
      
      <div class="card-content">
        <img class="card-icon" src="icon-120.png" alt="App Icon">
        
        <div class="card-meta">
          <h2>FunTap PUBG</h2>
          
          <div class="card-info">
            <strong>Key Free:</strong> 
            <code class="copy-code" id="copyText" onclick="copyKey(this)">
              CeniOs-hour-ijEXMWqmg1qyTa1d
            </code>
            <br>
            <strong>Th·ªùi Gian:</strong> 
            <div class="countdown-timer" data-endtime="3">
              <span class="timer-icon">‚è±Ô∏è</span>
              <span class="timer-text">ƒêang t·∫£i...</span>
            </div>
            <br>
            <strong>Version:</strong> 4.1
            <br>
            <strong>Hi·ªán Tr·∫°ng:</strong> 
            <span class="status-badge">Safe - Ch∆°i ƒê∆∞·ª£c Aim</span>
          </div>

          <div class="app-stats">
            <span class="app-stat">‚≠ê <span id="rating-pubg">4.8</span>/5 (<span id="rating-count-pubg">0</span>)</span>
            <span class="app-stat">üì• <span class="download-count" data-app="pubg">0</span> l∆∞·ª£t t·∫£i</span>
            <span class="app-stat">üî• Hot</span>
          </div>

          <div class="prices">
            <div class="price-item">Ng√†y: <del>80k</del> <strong>30k</strong></div>
            <div class="price-item">Tu·∫ßn: <del>300k</del> <strong>150k</strong></div>
            <div class="price-item">Th√°ng: <del>800k</del> <strong>350k</strong></div>
          </div>
        </div>
      </div>

      <div class="button-group">
        <a class="btn" href="itms-services://?action=download-manifest&url=https://k3ndzy.github.io/CeniOs/app.plist" onclick="handleInstall(this, 'pubg'); return true;">
          üì• C√†i ƒë·∫∑t
        </a>
        <button class="btn btn-favorite" onclick="toggleFavorite('pubg')">
          <span class="favorite-icon" id="fav-pubg">ü§ç</span> Y√™u th√≠ch
        </button>
        <a class="btn" href="https://hackmod.vn" target="_blank">
          üîë L·∫•y Key (3k)
        </a>
        <a class="btn" href="https://baontq.xyz/xiao.php?code=073066d2-230a-4f8b-aa45-57dbfa9b8fdc" target="_blank">
          üîë FunLink 5H Free (V∆∞·ª£t Link 2 l·∫ßn )
        </a>
        <a class="btn" href="https://baontq.xyz/xiao.php?code=142f23d8-f858-40f4-a0ca-4b8f0872c8e3" target="_blank">
          üîë L·∫•y M√£ 5H Free (V∆∞·ª£t Link 2 L·∫ßn )
        </a>
      </div>
<!-- 
      <div class="reviews-section">
        <h3>üí¨ ƒê√°nh gi√° & Review</h3>
        <div class="rating-input">
          <div class="stars" data-app="pubg">
            <span class="star" data-rating="1">‚≠ê</span>
            <span class="star" data-rating="2">‚≠ê</span>
            <span class="star" data-rating="3">‚≠ê</span>
            <span class="star" data-rating="4">‚≠ê</span>
            <span class="star" data-rating="5">‚≠ê</span>
          </div>
          <input type="text" class="review-input" placeholder="Vi·∫øt ƒë√°nh gi√° c·ªßa b·∫°n..." data-app="pubg">
          <button class="btn-review" onclick="submitReview('pubg')">G·ª≠i</button>
        </div>
        <div class="reviews-list" id="reviews-pubg"></div>
      </div>
    </div> -->

    <!-- <div class="card" data-app="newapp">
      <img class="card-banner" src="icon-513.png" alt="App M·ªõi Banner">
      <span class="new-badge">üÜï M·ªöI</span>
      
      <div class="card-content">
        <img class="card-icon" src="icon-120.png" alt="App Icon">
        
        <div class="card-meta">
          <h2>FunTap Ko Gi·∫≠t</h2>
          
          <div class="card-info">
            <strong>Key Free:</strong> 
            <code class="copy-code" onclick="copyKey(this)">
              NewApp-Key-ABC123XYZ
            </code>
            <br>
            <strong>Th·ªùi Gian:</strong> 
            <div class="countdown-timer" data-endtime="6">
              <span class="timer-icon">‚è±Ô∏è</span>
              <span class="timer-text">ƒêang t·∫£i...</span>
            </div>
            <br>
            <strong>Version:</strong> 1.0
            <br>
            <strong>Hi·ªán Tr·∫°ng:</strong> 
            <span class="status-badge">An To√†n</span>
          </div>

          <div class="app-stats">
            <span class="app-stat">‚≠ê 4.9/5</span>
            <span class="app-stat">üì• <span class="download-count">8,521</span> l∆∞·ª£t t·∫£i</span>
          </div>

          <div class="prices">
            <div class="price-item">Ng√†y: <del>50k</del> <strong>25k</strong></div>
            <div class="price-item">Tu·∫ßn: <del>200k</del> <strong>100k</strong></div>
            <div class="price-item">Th√°ng: <del>600k</del> <strong>300k</strong></div>
          </div>
        </div>
      </div>

      <div class="button-group">
        <a class="btn" href="itms-services://?action=download-manifest&url=https://k3ndzy.github.io/CeniOs/Kogiat.plist" onclick="handleInstall(this, 'newapp')">
          üì• C√†i ƒë·∫∑t
        </a>
        <a class="btn" href="https://hackmod.vn" target="_blank">
          üîë L·∫•y Key (1k-3k)
        </a>
      </div>

      <div class="reviews-section">
        <h3>üí¨ ƒê√°nh gi√° & Review</h3>
        <div class="rating-input">
          <div class="stars" data-app="newapp">
            <span class="star" data-rating="1">‚≠ê</span>
            <span class="star" data-rating="2">‚≠ê</span>
            <span class="star" data-rating="3">‚≠ê</span>
            <span class="star" data-rating="4">‚≠ê</span>
            <span class="star" data-rating="5">‚≠ê</span>
          </div>
          <input type="text" class="review-input" placeholder="Vi·∫øt ƒë√°nh gi√° c·ªßa b·∫°n..." data-app="newapp">
          <button class="btn-review" onclick="submitReview('newapp')">G·ª≠i</button>
        </div>
        <div class="reviews-list" id="reviews-newapp"></div>
      </div>
    </div> -->

    <div class="card" data-app="aov" style="display: none;">
      <img class="card-banner" src="Aov.png" alt="Cen Map AOV Banner">
      
      <div class="card-content">
        <img class="card-icon" src="icon-120.png" alt="App Icon">
        
        <div class="card-meta">
          <h2>Cen Map AOV 1.6.0</h2>
          
          <div class="card-info">
            <strong>Version:</strong> 4.1
            <br>
            <strong>Bundle ID:</strong> <code>com.soimap.game.kvgn.map</code>
            <br>
            <strong>Hi·ªán Tr·∫°ng:</strong> 
            <span class="status-badge">An To√†n</span>
          </div>

          <div class="app-stats">
            <span class="app-stat">‚≠ê <span id="rating-aov">4.7</span>/5 (<span id="rating-count-aov">0</span>)</span>
            <span class="app-stat">üì• <span class="download-count" data-app="aov">0</span> l∆∞·ª£t t·∫£i</span>
          </div>

          <div class="prices">
            <div class="price-item">Ng√†y: <del>50k</del> <strong>35k</strong></div>
            <div class="price-item">Tu·∫ßn: <del>150k</del> <strong>80k</strong></div>
            <div class="price-item">Th√°ng: <del>350k</del> <strong>200k</strong></div>
          </div>
        </div>
      </div>

      <div class="button-group">
        <a class="btn" href="itms-services://?action=download-manifest&url=https://k3ndzy.github.io/LinkTaiPUBG/lienquanvu.plist" onclick="handleInstall(this, 'aov'); return true;">
          üì• C√†i ƒë·∫∑t
        </a>
        <button class="btn btn-favorite" onclick="toggleFavorite('aov')">
          <span class="favorite-icon" id="fav-aov">ü§ç</span> Y√™u th√≠ch
        </button>
        <a class="btn" href="https://hackmod.vn" target="_blank">
          üí≥ Mua Key Tr·ª±c Ti·∫øp
        </a>
        <a class="btn" href="https://link4sub.com/9WwM" target="_blank">
          üéÅ Fun Link 1 Ng√†y (Free)
        </a>
        <a class="btn" href="https://baontq.xyz/xiao.php?code=6c846ca8-61cd-4a25-a6fa-884debe29665" target="_blank">
          üéÅ L·∫•y M√£ 1 Ng√†y (Free)
        </a>
      </div>

      <!-- <div class="reviews-section">
        <h3>üí¨ ƒê√°nh gi√° & Review</h3>
        <div class="rating-input">
          <div class="stars" data-app="aov">
            <span class="star" data-rating="1">‚≠ê</span>
            <span class="star" data-rating="2">‚≠ê</span>
            <span class="star" data-rating="3">‚≠ê</span>
            <span class="star" data-rating="4">‚≠ê</span>
            <span class="star" data-rating="5">‚≠ê</span>
          </div>
          <input type="text" class="review-input" placeholder="Vi·∫øt ƒë√°nh gi√° c·ªßa b·∫°n..." data-app="aov">
          <button class="btn-review" onclick="submitReview('aov')">G·ª≠i</button>
        </div>
        <div class="reviews-list" id="reviews-aov"></div>
      </div>
    </div> -->

    <div class="trust-guide">
      <h2>üì± H∆∞·ªõng D·∫´n Tin C·∫≠y</h2>
      <div class="steps">
        <div class="step">
          <p><strong>B∆∞·ªõc 1</strong></p>
          <img src="hd1.png" alt="B∆∞·ªõc 1 - M·ªü Settings">
        </div>
        <div class="step">
          <p><strong>B∆∞·ªõc 2</strong></p>
          <img src="hd2.png" alt="B∆∞·ªõc 2 - Ch·ªçn General">
        </div>
        <div class="step">
          <p><strong>B∆∞·ªõc 3</strong></p>
          <img src="hd3.png" alt="B∆∞·ªõc 3 - Tin c·∫≠y">
        </div>
      </div>
    </div>

    <!-- Key Validation Modal -->
    <div id="keyModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
      <div style="background: white; padding: 32px; border-radius: 16px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: slideUp 0.3s ease;">
        <h2 style="margin-bottom: 16px; font-size: 24px;">üîë Nh·∫≠p Key K√≠ch Ho·∫°t</h2>
        <p style="color: #666; margin-bottom: 20px; font-size: 14px;">Nh·∫≠p key free t·ª´ link b√™n d∆∞·ªõi ƒë·ªÉ k√≠ch ho·∫°t ·ª©ng d·ª•ng</p>
        
        <input type="text" id="keyInput" placeholder="V√≠ d·ª•: CENIOS-ABC123XYZ" 
               style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; margin-bottom: 16px;" />
        
        <div id="keyValidation" style="margin-bottom: 16px;"></div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <button onclick="validateKey()" style="padding: 12px; background: #1a73e8; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">‚úÖ X√°c Nh·∫≠n</button>
          <button onclick="closeKeyModal()" style="padding: 12px; background: #f1f1f1; color: #333; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">‚ùå ƒê√≥ng</button>
        </div>
        
        <p style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0; text-align: center; font-size: 12px; color: #666;">
          ‚ö†Ô∏è <strong>Kh√¥ng c√≥ key?</strong> <a href="https://t.me/CenIOSMOD" target="_blank" style="color: #1a73e8; text-decoration: none;">L·∫•y key free t·∫°i ƒë√¢y</a>
        </p>
      </div>
    </div>

    <style>
      @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      
      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #1a73e8;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>

    <footer class="footer">
      <p>
        üì± M·ªü b·∫±ng Safari (iPhone/iPad) ‚Üí Nh·∫•n n√∫t C√†i ƒë·∫∑t
      </p>
      <p>
        ‚≠êÔ∏è <strong>Zalo Admin:</strong> <a href="https://zalo.me/420773099399" target="_blank">Cen iOS</a>
        <br>
        üì≤ <strong>Telegram:</strong> <a href="https://t.me/cenios" target="_blank">Cen iOS</a>
        <br>
        üéÄ <strong>Nh√≥m L·∫•y Key Free:</strong> <a href="https://t.me/CenIOSMOD" target="_blank">Click v√†o ƒë√¢y</a>
      </p>
    </footer>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "cenios-store.firebaseapp.com",
      databaseURL: "https://cenios-store-default-rtdb.firebaseio.com",
      projectId: "cenios-store",
      storageBucket: "cenios-store.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcdef123456"
    };

    // Initialize Firebase
    let db, analytics;
    let firebaseEnabled = false;
    
    try {
      if (typeof firebase !== 'undefined') {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        analytics = firebase.analytics();
        firebaseEnabled = true;
        console.log('‚úÖ Firebase initialized successfully');
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è Firebase not available, using fallback mode:', error.message);
      firebaseEnabled = false;
    }

    let selectedRatings = { pubg: 0, newapp: 0, aov: 0 };
    let sessionId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

    // Detect system theme preference
    function getSystemTheme() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    function applyTheme(theme) {
      const btn = document.querySelector('.toggle-theme');
      if (theme === 'dark') {
        document.body.classList.add('dark');
        btn.textContent = '‚òÄÔ∏è Chuy·ªÉn n·ªÅn';
      } else {
        document.body.classList.remove('dark');
        btn.textContent = 'üåô Chuy·ªÉn n·ªÅn';
      }
    }

    function toggleTheme() {
      const currentTheme = document.body.classList.contains('dark') ? 'dark' : 'light';
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      applyTheme(newTheme);
      localStorage.setItem('theme', newTheme);
    }

    // Listen for system theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
      // Only apply if user hasn't manually set a theme
      if (!localStorage.getItem('theme')) {
        applyTheme(e.matches ? 'dark' : 'light');
      }
    });

    function copyKey(element) {
      const text = element.textContent.trim();
      navigator.clipboard.writeText(text).then(() => {
        alert('‚úÖ ƒê√£ copy key!\n\n' + text + '\n\nH√£y d√°n v√†o ·ª©ng d·ª•ng');
      }).catch(() => {
        alert('‚ùå Kh√¥ng th·ªÉ copy. Vui l√≤ng copy th·ªß c√¥ng.');
      });
    }

    function handleInstall(button, appId) {
      const originalText = button.innerHTML;
      button.innerHTML = '‚è≥ ƒêang t·∫£i...';
      button.style.pointerEvents = 'none';
      
      // Track installation
      trackInstallation(appId);
      incrementDownload(appId);
      
      // Log to analytics
      if (firebaseEnabled && analytics) {
        try {
          analytics.logEvent('app_install', {
            app_id: appId,
            timestamp: new Date().toISOString()
          });
        } catch (error) {
          console.warn('Analytics error:', error);
        }
      }
      
      setTimeout(() => {
        button.innerHTML = '‚úÖ ƒê√£ b·∫Øt ƒë·∫ßu t·∫£i';
        setTimeout(() => {
          button.innerHTML = originalText;
          button.style.pointerEvents = 'auto';
        }, 1500);
      }, 1000);
    }

    function trackInstallation(appId) {
      if (!firebaseEnabled) return;
      
      try {
        const timestamp = Date.now();
        const dateKey = new Date().toISOString().split('T')[0];
        
        // Increment total downloads
        db.ref(`stats/downloads/${appId}/total`).transaction((current) => {
          return (current || 0) + 1;
        });
        
        // Increment today's downloads
        db.ref(`stats/downloads/${appId}/daily/${dateKey}`).transaction((current) => {
          return (current || 0) + 1;
        });
        
        // Log installation event
        db.ref(`stats/installations/${appId}`).push({
          timestamp: timestamp,
          sessionId: sessionId,
          date: dateKey
        });
      } catch (error) {
        console.warn('Track installation error:', error);
      }
    }

    function incrementDownload(appId) {
      const countElem = document.querySelector(`.download-count[data-app="${appId}"]`);
      if (countElem) {
        let count = parseInt(countElem.textContent.replace(/,/g, '') || '0');
        count++;
        countElem.textContent = count.toLocaleString();
        
        // Animate the number
        countElem.style.transform = 'scale(1.2)';
        countElem.style.color = 'var(--success-color)';
        setTimeout(() => {
          countElem.style.transform = 'scale(1)';
          countElem.style.color = '';
        }, 300);
      }
      
      updateTotalDownloads();
    }

    function updateTotalDownloads() {
      let total = 0;
      document.querySelectorAll('.download-count').forEach(elem => {
        total += parseInt(elem.textContent.replace(/,/g, '') || '0');
      });
      document.getElementById('totalDownloads').textContent = total.toLocaleString();
    }

    function loadDownloadStats() {
      if (!firebaseEnabled) {
        // Fallback to local numbers
        loadLocalDownloadStats();
        return;
      }
      
      try {
        const dateKey = new Date().toISOString().split('T')[0];
        
        // Load total downloads for each app
        ['pubg', 'aov'].forEach(appId => {
          db.ref(`stats/downloads/${appId}/total`).once('value', (snapshot) => {
            const count = snapshot.val() || 0;
            const elem = document.querySelector(`.download-count[data-app="${appId}"]`);
            if (elem) {
              elem.textContent = count.toLocaleString();
            }
          });
        });
        
        // Load today's total downloads
        let todayTotal = 0;
        const promises = ['pubg', 'aov'].map(appId => 
          db.ref(`stats/downloads/${appId}/daily/${dateKey}`).once('value')
        );
        
        Promise.all(promises).then(snapshots => {
          snapshots.forEach(snapshot => {
            todayTotal += snapshot.val() || 0;
          });
          document.getElementById('todayDownloads').textContent = todayTotal.toLocaleString();
        });
        
      } catch (error) {
        console.warn('Load stats error:', error);
        loadLocalDownloadStats();
      }
    }

    function loadLocalDownloadStats() {
      // Fallback v·ªõi s·ªë li·ªáu local
      const stats = {
        pubg: parseInt(localStorage.getItem('downloads_pubg') || '15234'),
        aov: parseInt(localStorage.getItem('downloads_aov') || '12890')
      };
      
      Object.keys(stats).forEach(appId => {
        const elem = document.querySelector(`.download-count[data-app="${appId}"]`);
        if (elem) elem.textContent = stats[appId].toLocaleString();
      });
      
      updateTotalDownloads();
    }

    function updateOnlineCount() {
      if (!firebaseEnabled) {
        // Fallback: realistic s·ªë d·ª±a tr√™n th·ªùi gian
        const hour = new Date().getHours();
        let baseCount;
        
        if (hour >= 19 && hour <= 23) {
          baseCount = 180; // Prime time
        } else if (hour >= 12 && hour <= 18) {
          baseCount = 140;
        } else if (hour >= 6 && hour <= 11) {
          baseCount = 100;
        } else {
          baseCount = 60; // Late night
        }
        
        const variance = Math.floor(Math.random() * 30) - 15;
        const count = baseCount + variance;
        document.getElementById('onlineCount').textContent = count;
        return;
      }
      
      try {
        // Register this session as online
        const sessionRef = db.ref(`sessions/${sessionId}`);
        sessionRef.set({
          online: true,
          lastSeen: firebase.database.ServerValue.TIMESTAMP
        });
        
        // Remove on disconnect
        sessionRef.onDisconnect().remove();
        
        // Count active sessions (last 5 minutes)
        const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
        db.ref('sessions').orderByChild('lastSeen').startAt(fiveMinutesAgo).once('value', (snapshot) => {
          const count = snapshot.numChildren();
          document.getElementById('onlineCount').textContent = count;
        });
        
        // Update presence every 30 seconds
        setInterval(() => {
          sessionRef.update({ lastSeen: firebase.database.ServerValue.TIMESTAMP });
        }, 30000);
        
      } catch (error) {
        console.warn('Online count error:', error);
      }
    }

    function initCountdowns() {
      document.querySelectorAll('.countdown-timer').forEach(timer => {
        const hours = parseInt(timer.getAttribute('data-endtime'));
        const endTime = new Date().getTime() + (hours * 60 * 60 * 1000);
        
        const updateTimer = () => {
          const now = new Date().getTime();
          const distance = endTime - now;
          
          if (distance < 0) {
            timer.querySelector('.timer-text').textContent = 'H·∫øt h·∫°n';
            return;
          }
          
          const h = Math.floor(distance / (1000 * 60 * 60));
          const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
          const s = Math.floor((distance % (1000 * 60)) / 1000);
          
          timer.querySelector('.timer-text').textContent = 
            `${h}h ${m}m ${s}s c√≤n l·∫°i`;
        };
        
        updateTimer();
        setInterval(updateTimer, 1000);
      });
    }

    function submitReview(appId) {
      const rating = selectedRatings[appId];
      const input = document.querySelector(`.review-input[data-app="${appId}"]`);
      const text = input.value.trim();
      
      if (rating === 0) {
        showNotification('‚ö†Ô∏è Vui l√≤ng ch·ªçn s·ªë sao ƒë√°nh gi√°!', 3000);
        return;
      }
      
      if (text === '' || text.length < 10) {
        showNotification('‚ö†Ô∏è ƒê√°nh gi√° ph·∫£i c√≥ √≠t nh·∫•t 10 k√Ω t·ª±!', 3000);
        return;
      }
      
      const review = {
        rating: rating,
        text: text,
        timestamp: Date.now(),
        date: new Date().toLocaleDateString('vi-VN'),
        time: new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }),
        sessionId: sessionId
      };
      
      if (firebaseEnabled) {
        // Save to Firebase
        try {
          db.ref(`reviews/${appId}`).push(review).then(() => {
            showNotification('‚úÖ C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√°!', 3000);
            input.value = '';
            selectedRatings[appId] = 0;
            resetStars(appId);
            loadReviews(appId);
            updateAppRating(appId);
          }).catch(error => {
            console.error('Review save error:', error);
            saveReviewLocal(appId, review);
          });
        } catch (error) {
          saveReviewLocal(appId, review);
        }
      } else {
        saveReviewLocal(appId, review);
      }
    }

    function saveReviewLocal(appId, review) {
      const reviews = JSON.parse(localStorage.getItem(`reviews_${appId}`) || '[]');
      reviews.unshift(review);
      localStorage.setItem(`reviews_${appId}`, JSON.stringify(reviews.slice(0, 50)));
      
      const input = document.querySelector(`.review-input[data-app="${appId}"]`);
      if (input) input.value = '';
      selectedRatings[appId] = 0;
      resetStars(appId);
      loadReviews(appId);
      showNotification('‚úÖ ƒê√°nh gi√° c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c l∆∞u!', 3000);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function loadReviews(appId) {
      const container = document.getElementById(`reviews-${appId}`);
      if (!container) return;
      
      if (firebaseEnabled) {
        try {
          db.ref(`reviews/${appId}`).orderByChild('timestamp').limitToLast(20).once('value', (snapshot) => {
            const reviews = [];
            snapshot.forEach((childSnapshot) => {
              reviews.unshift(childSnapshot.val());
            });
            displayReviews(appId, reviews, container);
          });
          return;
        } catch (error) {
          console.warn('Load reviews error:', error);
        }
      }
      
      // Fallback to local storage
      const reviews = JSON.parse(localStorage.getItem(`reviews_${appId}`) || '[]');
      displayReviews(appId, reviews, container);
    }

    function displayReviews(appId, reviews, container) {
      if (reviews.length === 0) {
        container.innerHTML = '<p class="no-reviews">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n! üåü</p>';
        return;
      }
      
      container.innerHTML = reviews.slice(0, 20).map(review => `
        <div class="review-item">
          <div class="review-header">
            <span class="review-stars">${'‚≠ê'.repeat(review.rating)}</span>
            <span class="review-date">${escapeHtml(review.date)} ${escapeHtml(review.time)}</span>
          </div>
          <p class="review-text">${escapeHtml(review.text)}</p>
        </div>
      `).join('');
    }

    function updateAppRating(appId) {
      if (!firebaseEnabled) return;
      
      try {
        db.ref(`reviews/${appId}`).once('value', (snapshot) => {
          let totalRating = 0;
          let count = 0;
          
          snapshot.forEach((childSnapshot) => {
            const review = childSnapshot.val();
            if (review.rating) {
              totalRating += review.rating;
              count++;
            }
          });
          
          if (count > 0) {
            const avgRating = (totalRating / count).toFixed(1);
            const ratingElem = document.getElementById(`rating-${appId}`);
            const countElem = document.getElementById(`rating-count-${appId}`);
            
            if (ratingElem) ratingElem.textContent = avgRating;
            if (countElem) countElem.textContent = count;
          }
        });
      } catch (error) {
        console.warn('Update rating error:', error);
      }
    }

    function resetStars(appId) {
      const stars = document.querySelectorAll(`.stars[data-app="${appId}"] .star`);
      stars.forEach(star => star.classList.remove('selected'));
    }

    function showNotification(message, duration = 5000) {
      const notification = document.getElementById('notification');
      notification.querySelector('.notification-text').textContent = message;
      notification.classList.remove('hidden');
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          notification.classList.add('hidden');
        }, 300);
      }, duration);
    }

    function toggleFavorite(appId) {
      const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
      const icon = document.getElementById(`fav-${appId}`);
      
      if (favorites.includes(appId)) {
        // Remove from favorites
        const index = favorites.indexOf(appId);
        favorites.splice(index, 1);
        icon.textContent = 'ü§ç';
        showNotification('üíî ƒê√£ x√≥a kh·ªèi y√™u th√≠ch', 2000);
      } else {
        // Add to favorites
        favorites.push(appId);
        icon.textContent = '‚ù§Ô∏è';
        showNotification('‚ù§Ô∏è ƒê√£ th√™m v√†o y√™u th√≠ch', 2000);
      }
      
      localStorage.setItem('favorites', JSON.stringify(favorites));
    }

    function loadFavorites() {
      const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
      favorites.forEach(appId => {
        const icon = document.getElementById(`fav-${appId}`);
        if (icon) icon.textContent = '‚ù§Ô∏è';
      });
    }

    function closeNotification() {
      document.getElementById('notification').classList.add('hidden');
    }

    // Cleanup old sessions periodically
    function cleanupOldSessions() {
      if (!firebaseEnabled) return;
      
      try {
        const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
        db.ref('sessions').orderByChild('lastSeen').endAt(fiveMinutesAgo).once('value', (snapshot) => {
          snapshot.forEach((childSnapshot) => {
            childSnapshot.ref.remove();
          });
        });
      } catch (error) {
        console.warn('Cleanup error:', error);
      }
    }

    // Error handling
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      // Don't show to user, just log
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
    });

    document.addEventListener('DOMContentLoaded', () => {
      // Load theme - prefer user setting, fallback to system preference
      const savedTheme = localStorage.getItem('theme');
      const themeToApply = savedTheme || getSystemTheme();
      applyTheme(themeToApply);
      
      // Initialize all features
      initCountdowns();
      loadDownloadStats();
      updateOnlineCount();
      loadFavorites();
      
      // Load reviews and ratings
      ['pubg', 'aov'].forEach(appId => {
        loadReviews(appId);
        updateAppRating(appId);
      });
      
      // Setup star rating system
      document.querySelectorAll('.stars').forEach(starsContainer => {
        const appId = starsContainer.getAttribute('data-app');
        starsContainer.querySelectorAll('.star').forEach(star => {
          star.addEventListener('click', () => {
            const rating = parseInt(star.getAttribute('data-rating'));
            selectedRatings[appId] = rating;
            
            starsContainer.querySelectorAll('.star').forEach((s, index) => {
              if (index < rating) {
                s.classList.add('selected');
              } else {
                s.classList.remove('selected');
              }
            });
          });
        });
      });
      
      // Update online count regularly
      setInterval(updateOnlineCount, 60000);
      
      // Cleanup old sessions every 5 minutes
      setInterval(cleanupOldSessions, 300000);
      
      // Track page view
      if (firebaseEnabled && analytics) {
        try {
          analytics.logEvent('page_view', {
            page_title: 'Cen iOS Store',
            page_location: window.location.href
          });
        } catch (error) {
          console.warn('Analytics error:', error);
        }
      }
    });

    // ========== KEY VALIDATION SYSTEM ==========
    let userDeviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    let activeKeys = {};

    function openKeyModal() {
      document.getElementById('keyModal').style.display = 'flex';
      document.getElementById('keyInput').focus();
    }

    function closeKeyModal() {
      document.getElementById('keyModal').style.display = 'none';
      document.getElementById('keyInput').value = '';
      document.getElementById('keyValidation').innerHTML = '';
    }

    function validateKey() {
      if (!firebaseEnabled) {
        showNotification('‚ùå System kh√¥ng k·∫øt n·ªëi Firebase', 3000);
        return;
      }

      const keyCode = document.getElementById('keyInput').value.toUpperCase().trim();
      if (!keyCode) {
        showNotification('‚ùå Vui l√≤ng nh·∫≠p key!', 3000);
        return;
      }

      document.getElementById('keyValidation').innerHTML = '<div class="loading" style="margin: 0 auto;"></div>';

      try {
        db.ref(`keys/${keyCode}`).once('value', (snapshot) => {
          const validationDiv = document.getElementById('keyValidation');

          if (!snapshot.exists()) {
            validationDiv.innerHTML = '<p style="color: #d32f2f; font-weight: 600;">‚ùå Key kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng t·ªìn t·∫°i</p>';
            return;
          }

          const key = snapshot.val();
          const now = Date.now();

          // Validate key
          if (key.status !== 'active') {
            validationDiv.innerHTML = '<p style="color: #d32f2f; font-weight: 600;">‚ùå Key ƒë√£ h·∫øt hi·ªáu l·ª±c</p>';
            return;
          }

          if (now > key.expiry) {
            validationDiv.innerHTML = '<p style="color: #d32f2f; font-weight: 600;">‚ùå Key ƒë√£ h·∫øt h·∫°n</p>';
            return;
          }

          if (key.used >= key.maxUses) {
            validationDiv.innerHTML = '<p style="color: #d32f2f; font-weight: 600;">‚ùå Key ƒë√£ d√πng h·∫øt s·ªë l·∫ßn</p>';
            return;
          }

          // Key valid!
          activeKeys[keyCode] = key;
          localStorage.setItem('activeKey', keyCode);
          localStorage.setItem('keyExpiry', key.expiry);

          // Increment usage
          db.ref(`keys/${keyCode}/used`).transaction(current => (current || 0) + 1);
          
          // Log usage
          db.ref(`keys/${keyCode}/lastUsedBy`).set({
            deviceId: userDeviceId,
            timestamp: now,
            date: new Date().toLocaleString('vi-VN')
          });

          const remainingTime = Math.round((key.expiry - now) / (1000 * 60 * 60));
          validationDiv.innerHTML = `
            <div style="background: #c8e6c9; color: #2e7d32; padding: 12px; border-radius: 8px; border-left: 4px solid #4caf50; font-weight: 600;">
              ‚úÖ K√≠ch ho·∫°t th√†nh c√¥ng!<br>
              <span style="font-size: 12px; margin-top: 4px; display: block;">H·∫øt h·∫°n trong ${remainingTime}h</span>
            </div>
          `;

          setTimeout(() => {
            showNotification('‚úÖ ·ª®ng d·ª•ng ƒë√£ k√≠ch ho·∫°t!', 3000);
            closeKeyModal();
          }, 1500);
        });
      } catch (error) {
        console.error('Key validation error:', error);
        showNotification('‚ùå L·ªói khi ki·ªÉm tra key: ' + error.message, 3000);
      }
    }

    function checkKeyExpiry() {
      const keyExpiry = localStorage.getItem('keyExpiry');
      if (keyExpiry && Date.now() > parseInt(keyExpiry)) {
        localStorage.removeItem('activeKey');
        localStorage.removeItem('keyExpiry');
        showNotification('‚ö†Ô∏è Key c·ªßa b·∫°n ƒë√£ h·∫øt h·∫°n', 3000);
      }
    }

    // Check key expiry every minute
    setInterval(checkKeyExpiry, 60000);

    // Add keyboard support
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Enter' && document.getElementById('keyModal').style.display === 'flex') {
        validateKey();
      }
      if (event.key === 'Escape') {
        closeKeyModal();
      }
    });

    // ========== DAILY KEY DISPLAY SYSTEM ==========
    let dailyKeyUpdateInterval = null;

    async function loadAndDisplayDailyKey() {
      if (!firebaseEnabled) {
        console.log('Firebase not enabled, skipping daily key load');
        return;
      }

      try {
        const todayDate = new Date().toISOString().split('T')[0];
        const snapshot = await db.ref(`dailyKeys/${todayDate}`).once('value');

        if (snapshot.exists()) {
          const key = snapshot.val();
          displayDailyKeyBanner(key);
          
          // Update countdown timer
          clearInterval(dailyKeyUpdateInterval);
          dailyKeyUpdateInterval = setInterval(() => {
            updateDailyKeyCountdown(key.expiry);
          }, 1000);
          
          updateDailyKeyCountdown(key.expiry);
        } else {
          // Hide banner if no daily key
          document.getElementById('dailyKeyBanner').style.display = 'none';
        }
      } catch (error) {
        console.error('Error loading daily key:', error);
      }
    }

    function displayDailyKeyBanner(key) {
      const banner = document.getElementById('dailyKeyBanner');
      if (!banner) return;

      document.getElementById('dailyKeyCodeDisplay').textContent = key.code;
      document.getElementById('dailyKeyAppBadge').textContent = 
        key.app === 'pubg' ? 'FunTap PUBG' : 'Cen Map AOV';
      document.getElementById('dailyKeyUsed').textContent = key.used || 0;
      document.getElementById('dailyKeyMax').textContent = key.maxUses;
      document.getElementById('dailyKeyDuration').textContent = key.duration;
      
      banner.style.display = 'block';
      banner.style.animation = 'slideUp 0.6s ease-out';
    }

    function updateDailyKeyCountdown(expiryTime) {
      const now = Date.now();
      const remaining = expiryTime - now;

      if (remaining <= 0) {
        document.getElementById('dailyKeyCountdown').textContent = '‚è∞ H·∫øt h·∫°n';
        document.getElementById('dailyKeyBanner').style.display = 'none';
        clearInterval(dailyKeyUpdateInterval);
        return;
      }

      const hours = Math.floor(remaining / (1000 * 60 * 60));
      const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((remaining % (1000 * 60)) / 1000);

      document.getElementById('dailyKeyCountdown').textContent = 
        `${hours}h ${minutes}m ${seconds}s`;
    }

    function copyDailyKeyFromWebsite() {
      const keyCode = document.getElementById('dailyKeyCodeDisplay').textContent;
      navigator.clipboard.writeText(keyCode).then(() => {
        showNotification('‚úÖ ƒê√£ copy key! D√°n v√†o √¥ ƒë·∫ßu ti√™n ƒë·ªÉ k√≠ch ho·∫°t.', 3000);
      }).catch(() => {
        showNotification('‚ùå Kh√¥ng th·ªÉ copy', 3000);
      });
    }

    function activateDailyKey() {
      const keyCode = document.getElementById('dailyKeyCodeDisplay').textContent;
      if (keyCode && keyCode !== 'Loading...') {
        document.getElementById('keyInput').value = keyCode;
        openKeyModal();
      }
    }

    // Load daily key on page load
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        loadAndDisplayDailyKey();
        
        // Check for new daily keys every 30 seconds
        setInterval(loadAndDisplayDailyKey, 30000);
      }, 1000);
    });

    // Setup real-time listener for daily key changes
    if (firebaseEnabled) {
      try {
        const todayDate = new Date().toISOString().split('T')[0];
        db.ref(`dailyKeys/${todayDate}`).on('value', (snapshot) => {
          if (snapshot.exists()) {
            displayDailyKeyBanner(snapshot.val());
            updateDailyKeyCountdown(snapshot.val().expiry);
          }
        });
      } catch (error) {
        console.error('Error setting up daily key listener:', error);
      }
    }

    // ========== GAME SIDEBAR FUNCTIONS ==========
    const gameData = {
      pubg: {
        name: 'FunTap PUBG',
        icon: 'Cenios.png',
        banner: 'banner.jpg',
        version: '4.1',
        status: 'Safe - Ch∆°i ƒê∆∞·ª£c Aim',
        key: 'CeniOs-hour-ijEXMWqmg1qyTa1d',
        duration: 3,
        prices: {
          day: { old: '80k', new: '30k' },
          week: { old: '300k', new: '150k' },
          month: { old: '800k', new: '350k' }
        },
        links: {
          install: 'itms-services://?action=download-manifest&url=https://k3ndzy.github.io/CeniOs/app.plist',
          getKey: 'https://hackmod.vn'
        }
      },
      pubgkorea: {
        name: 'PUBG Korea',
        icon: 'Cenios.png',
        banner: 'banner.jpg',
        version: '4.1',
        status: 'Safe - Ch∆°i ƒê∆∞·ª£c Aim',
        key: 'CeniOs-korea-ijEXMWqmg1qyTa1d',
        duration: 3,
        prices: {
          day: { old: '80k', new: '30k' },
          week: { old: '300k', new: '150k' },
          month: { old: '800k', new: '350k' }
        },
        links: {
          install: 'itms-services://?action=download-manifest&url=https://k3ndzy.github.io/CeniOs/app.plist',
          getKey: 'https://hackmod.vn'
        }
      },
      aov: {
        name: 'Li√™n Qu√¢n VN/TW/RoV',
        icon: 'Aov.png',
        banner: 'Aov.png',
        version: '1.0',
        status: 'Safe - Full Map',
        key: 'AOV-Key-XYZ123ABC',
        duration: 6,
        prices: {
          day: { old: '80k', new: '30k' },
          week: { old: '300k', new: '150k' },
          month: { old: '800k', new: '350k' }
        },
        links: {
          install: 'itms-services://?action=download-manifest&url=https://k3ndzy.github.io/CeniOs/lienquanvu.plist',
          getKey: 'https://hackmod.vn'
        }
      },
      tocchien: {
        name: 'T·ªëc Chi·∫øn All Version',
        icon: 'Tocchien.jpeg',
        banner: 'Tocchien.jpeg',
        version: '2.0',
        status: 'Safe - M·ªü Full Map + Speed',
        key: 'TocChien-Key-ABC456XYZ',
        duration: 6,
        prices: {
          day: { old: '80k', new: '30k' },
          week: { old: '300k', new: '150k' },
          month: { old: '800k', new: '350k' }
        },
        links: {
          install: 'itms-services://?action=download-manifest&url=https://k3ndzy.github.io/CeniOs/tocchien.plist',
          getKey: 'https://hackmod.vn'
        }
      },
      cod: {
        name: 'Call of Duty All Version',
        icon: 'COD.jpeg',
        banner: 'COD.jpeg',
        version: '1.5',
        status: 'Safe - Aim + Wall Hack',
        key: 'COD-Premium-789DEF',
        duration: 6,
        prices: {
          day: { old: '100k', new: '50k' },
          week: { old: '400k', new: '200k' },
          month: { old: '1000k', new: '500k' }
        },
        links: {
          install: 'itms-services://?action=download-manifest&url=https://k3ndzy.github.io/CeniOs/cod.plist',
          getKey: 'https://hackmod.vn'
        }
      },
      accrankvang: {
        name: 'Acc Test Rank V√†ng',
        icon: '35k.jpeg',
        banner: '35k.jpeg',
        version: '1.0',
        status: 'Test Account - Rank V√†ng',
        key: 'AccTest-RankVang-12345',
        duration: 24,
        prices: {
          day: { old: '50k', new: '35k' },
          week: { old: '200k', new: '140k' },
          month: { old: '500k', new: '350k' }
        },
        links: {
          install: 'itms-services://?action=download-manifest&url=https://k3ndzy.github.io/CeniOs/acctest.plist',
          getKey: 'https://hackmod.vn'
        }
      },
      acctrangutinh: {
        name: 'Acc Test Tr·∫Øng Tinh',
        icon: '10k.jpeg',
        banner: '10k.jpeg',
        version: '1.0',
        status: 'Test Account - Tr·∫Øng Tinh',
        key: 'AccTest-TrangUtinh-67890',
        duration: 24,
        prices: {
          day: { old: '30k', new: '15k' },
          week: { old: '120k', new: '70k' },
          month: { old: '350k', new: '180k' }
        },
        links: {
          install: 'itms-services://?action=download-manifest&url=https://k3ndzy.github.io/CeniOs/acctest.plist',
          getKey: 'https://hackmod.vn'
        }
      }
    };

    function openGameSidebar(gameId) {
      const sidebar = document.getElementById('gameSidebar');
      const content = document.getElementById('sidebarContent');
      const game = gameData[gameId];

      if (!game) return;

      content.innerHTML = `
        <div class="sidebar-header">
          <div class="sidebar-title">
            <img src="${game.icon}" alt="${game.name}">
            <span>${game.name}</span>
          </div>
          <button class="close-sidebar" onclick="closeGameSidebar()">√ó</button>
        </div>

        <div class="sidebar-section">
          <img src="${game.banner}" style="width: 100%; border-radius: 12px; margin-bottom: 12px;">
        </div>

        <div class="sidebar-section">
          <h3 style="margin: 0 0 8px 0; font-size: 16px;">üîë Key Free</h3>
          <code class="copy-code" onclick="copyKey(this)" style="display: block; padding: 10px; background: #e3f2fd; border-radius: 8px; cursor: pointer; text-align: center; font-weight: 600; font-size: 14px;">
            ${game.key}
          </code>
        </div>

        <div class="button-group" style="margin-top: 16px;">
          <a class="btn" href="${game.links.install}" onclick="handleInstall(this, '${gameId}'); return true;" style="width: 100%; text-align: center; display: block; margin-bottom: 10px; text-decoration: none;">
            üì• C√†i ƒê·∫∑t Ngay
          </a>
          <a class="btn" href="https://zalo.me/420773099399" target="_blank" style="width: 100%; text-align: center; display: block; text-decoration: none; margin-bottom: 10px; background: linear-gradient(135deg, #0084ff 0%, #0073e6 100%); color: white; font-weight: 600;">
            üí¨ Li√™n H·ªá Zalo ƒë·ªÉ L·∫•y Key
          </a>
          <a class="btn" href="https://funlink.fun/" target="_blank" style="width: 100%; text-align: center; display: block; text-decoration: none; margin-bottom: 10px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; font-weight: 600;">
            üéÅ V∆∞·ª£t Link Funlink 1
          </a>
          <a class="btn" href="https://funlink.fun/" target="_blank" style="width: 100%; text-align: center; display: block; text-decoration: none; margin-bottom: 16px; background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%); color: white; font-weight: 600;">
            üéÅ V∆∞·ª£t Link Funlink 2
          </a>
        </div>

        <div class="qr-section" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 16px; border-radius: 12px; margin-top: 16px; text-align: center;">
          <h3 style="margin: 0 0 12px 0; font-size: 16px; color: #2e7d32; display: flex; align-items: center; justify-content: center; gap: 8px;">
            <span>üì±</span> Qu√©t M√£ Thanh To√°n
          </h3>
          <div style="background: white; padding: 12px; border-radius: 12px; display: inline-block; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
            <img src="Pay.jpg" alt="QR Payment" id="qrImage" style="width: 200px; height: 200px; border-radius: 8px; display: block;" oncontextmenu="return true;">
          </div>
          <a href="Pay.jpg" download="QR-Payment.jpg" style="display: inline-block; margin-top: 12px; padding: 8px 20px; background: #2e7d32; color: white; text-decoration: none; border-radius: 8px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);">
            üíæ T·∫£i QR v·ªÅ m√°y
          </a>
          <p style="margin: 12px 0 0 0; font-size: 13px; color: #2e7d32; font-weight: 600; line-height: 1.5;">
            üí¨ Ae mua key n√†o th√¨ vi·∫øt n·ªôi dung ƒë·∫ßu key nh∆∞ th·∫ø v√† g·ª≠i zalo cho m√¨nh ƒë·ªÉ l·∫•y key
          </p>
        </div>

        <div class="trust-guide" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 16px; border-radius: 12px; color: white; margin-top: 16px;">
          <h3 style="margin: 0 0 12px 0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
            <span>üõ°Ô∏è</span> H∆∞·ªõng D·∫´n Tin C·∫≠y
          </h3>
          <ol style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.8;">
            <li>V√†o <strong>C√†i ƒë·∫∑t</strong> ‚Üí <strong>C√†i ƒë·∫∑t chung</strong></li>
            <li>Ch·ªçn <strong>VPN & Qu·∫£n l√Ω thi·∫øt b·ªã</strong></li>
            <li>T√¨m v√† ch·ªçn <strong>${game.name}</strong></li>
            <li>Nh·∫•n <strong>Tin c·∫≠y "${game.name}"</strong></li>
            <li>X√°c nh·∫≠n v√† m·ªü ·ª©ng d·ª•ng ‚úÖ</li>
          </ol>
          <div style="margin-top: 12px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px; font-size: 13px; text-align: center;">
            üí° Sau khi tin c·∫≠y, b·∫°n c√≥ th·ªÉ ch∆°i game m∆∞·ª£t m√†!
          </div>
        </div>
      `;

      sidebar.classList.add('active');
      document.body.style.overflow = 'hidden';

      // Initialize countdown for this game
      setTimeout(() => {
        const timer = content.querySelector('.countdown-timer');
        if (timer) {
          updateTimer(timer);
        }
      }, 100);

      // Update download count
      const downloadCountElement = content.querySelector(`.download-count[data-app="${gameId}"]`);
      if (downloadCountElement && window.downloadCounts) {
        downloadCountElement.textContent = window.downloadCounts[gameId] || 0;
      }

      // Add swipe gesture to close sidebar
      initSwipeGesture();
    }

    function closeGameSidebar() {
      const sidebar = document.getElementById('gameSidebar');
      const sidebarContent = document.querySelector('.sidebar-content');
      sidebar.classList.remove('active');
      document.body.style.overflow = '';
      
      // Reset transform to prevent stuck state
      if (sidebarContent) {
        sidebarContent.style.transform = '';
        sidebarContent.style.transition = '';
      }
    }

    // Swipe gesture handler
    function initSwipeGesture() {
      const sidebarContent = document.querySelector('.sidebar-content');
      if (!sidebarContent) return;
      
      let touchStartX = 0;
      let touchStartY = 0;
      let touchEndX = 0;
      let touchEndY = 0;
      let isDragging = false;

      sidebarContent.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
        isDragging = true;
      }, { passive: true });

      sidebarContent.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        
        const diffX = touchStartX - touchEndX;
        const diffY = Math.abs(touchStartY - touchEndY);
        
        // Only apply transform if horizontal swipe is dominant
        if (Math.abs(diffX) > diffY && diffX > 0) {
          const translateValue = Math.min(diffX, 300);
          sidebarContent.style.transform = `translateX(-${translateValue}px)`;
          sidebarContent.style.transition = 'none';
        }
      }, { passive: true });

      sidebarContent.addEventListener('touchend', (e) => {
        if (!isDragging) return;
        
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        
        const diffX = touchStartX - touchEndX;
        const diffY = Math.abs(touchStartY - touchEndY);
        
        // If swiped left more than 100px and horizontal swipe, close sidebar
        if (diffX > 100 && Math.abs(diffX) > diffY) {
          // Animate close
          sidebarContent.style.transition = 'transform 0.3s ease';
          sidebarContent.style.transform = 'translateX(-100%)';
          
          setTimeout(() => {
            closeGameSidebar();
          }, 300);
        } else {
          // Reset position with animation
          sidebarContent.style.transition = 'transform 0.3s ease';
          sidebarContent.style.transform = '';
        }
        
        isDragging = false;
      }, { passive: true });
    }

    // Close sidebar when pressing ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeGameSidebar();
      }
    });
  </script>
</body>
</html>
